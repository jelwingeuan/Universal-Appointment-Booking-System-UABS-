<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pick Your Slot</title>
    <link rel="stylesheet" href="../static/style.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.3/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://code.jquery.com/ui/1.13.3/jquery-ui.js"></script>
    <script src="../static/myscripts.js"></script>
    <style>
        .time-grid button.unavailable {
            background-color: red;
        }
    </style>
</head>
<body>
    <nav>
        <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/about">About</a></li>
            <li><a href="/appointment">Make An Appointment</a></li>
            {% if session['logged_in'] %}
            <li><a href="/logout">Logout</a></li>
            <li><a href="/profile">Profile</a></li>
            {% else %}
            <li><a href="/login">Login</a></li>
            <li><a href="/signup">Sign Up</a></li>
            {% endif %}
        </ul>
    </nav>

    <form id="appointment-form" method="post" action="/create_booking">
        <div class="appointmentwrapper">
            <div class="appointment-header">
                <h1>Pick Your Slot</h1>
                <div class="contactinfo">
                    <label>Choose Your Lecturer</label>
                    <select name="lecturer" class="bordered-select">
                        <option value="Willie Poh">Willie Poh</option>
                        <option value="William Ban">William Ban</option>
                        <option value="Angeline Pang">Angeline Pang</option>
                    </select>
                </div>
                <div class="contactinfo">
                    <label>Purpose of Appointment</label>
                    <select name="purpose" class="bordered-select">
                        <option value="">Select Appointment Option</option>
                        <option value="Academic Advising">Academic Advising</option>
                        <option value="Course Registration Assistance">Course Registration Assistance</option>
                        <option value="Tutoring Services">Tutoring Services</option>
                        <option value="Financial Aid Consultation">Financial Aid Consultation</option>
                        <option value="Career Counseling">Career Counseling</option>
                        <option value="Study Abroad Program Information Session">Study Abroad Program Information Session</option>
                        <option value="Research Project Guidance">Research Project Guidance</option>
                        <option value="Thesis/Dissertation Advisement">Thesis/Dissertation Advisement</option>
                        <option value="Internship/Co-op Placement Assistance">Internship/Co-op Placement Assistance</option>
                        <option value="Disability Services Consultation">Disability Services Consultation</option>
                        <option value="Mental Health Counseling">Mental Health Counseling</option>
                        <option value="Health Services Appointment">Health Services Appointment</option>
                        <option value="Library Research Assistance">Library Research Assistance</option>
                        <option value="Student Organization Advising">Student Organization Advising</option>
                        <option value="Housing Assistance">Housing Assistance</option>
                        <option value="Graduation Planning Session">Graduation Planning Session</option>
                        <option value="Transfer Credit Evaluation">Transfer Credit Evaluation</option>
                        <option value="Faculty Office Hours">Faculty Office Hours</option>
                        <option value="Student Conduct Consultation">Student Conduct Consultation</option>
                        <option value="Alumni Networking Session">Alumni Networking Session</option>  
                    </select>           
                </div>
            </div>
            <div class="datepicker">
                <label>Select Date</label>
                <input type="date" id="appointment-date" name="appointment_date" required>
                <div id="time-slots" class="time-grid">
                    <button type="submit" name="appointment_time" value="08:00 AM" {% if unavailable %}class="unavailable"{% endif %}>08:00 AM</button>
                    <button type="submit" name="appointment_time" value="09:00 AM" {% if unavailable %}class="unavailable"{% endif %}>09:00 AM</button>
                    <button type="submit" name="appointment_time" value="10:00 AM" {% if unavailable %}class="unavailable"{% endif %}>10:00 AM</button>
                    <button type="submit" name="appointment_time" value="11:00 AM" {% if unavailable %}class="unavailable"{% endif %}>11:00 AM</button>
                    <button type="submit" name="appointment_time" value="12:00 PM" {% if unavailable %}class="unavailable"{% endif %}>12:00 PM</button>
                    <button type="submit" name="appointment_time" value="01:00 PM" {% if unavailable %}class="unavailable"{% endif %}>01:00 PM</button>
                    <button type="submit" name="appointment_time" value="02:00 PM" {% if unavailable %}class="unavailable"{% endif %}>02:00 PM</button>
                    <button type="submit" name="appointment_time" value="03:00 PM" {% if unavailable %}class="unavailable"{% endif %}>03:00 PM</button>
                    <button type="submit" name="appointment_time" value="04:00 PM" {% if unavailable %}class="unavailable"{% endif %}>04:00 PM</button>
                    <button type="submit" name="appointment_time" value="05:00 PM" {% if unavailable %}class="unavailable"{% endif %}>05:00 PM</button>
                    <button type="submit" name="appointment_time" value="06:00 PM" {% if unavailable %}class="unavailable"{% endif %}>06:00 PM</button>
                </div>                    
            </div>
        </div>
    </form>

    <script>
        $(document).ready(function() {
            // Function to check availability asynchronously
            function checkAvailability() {
                var lecturer = $("select[name='lecturer']").val();
                var date = $("#appointment-date").val();
                var formData = {
                    lecturer: lecturer,
                    appointment_date: date
                };
                $.ajax({
                    type: "POST",
                    url: "/check_availability",
                    data: formData,
                    dataType: "json",
                    success: function(response) {
                        if (response.availability === "available") {
                            // Enable all time slots
                            $("#time-slots button").removeClass("unavailable");
                        } else {
                            // Disable unavailable time slots
                            $("#time-slots button").addClass("unavailable");
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error("Error:", error);
                    }
                });
            }
    
            // Event listener for date change
            $("#appointment-date").on("change", function() {
                checkAvailability();
            });
    
            // Initial check for availability
            checkAvailability();
    
            // Event listener for form submission
            $("#appointment-form").on("submit", function(event) {
                event.preventDefault(); // Prevent default form submission
                // Manually submit the form if availability check is successful
                if (!$("#time-slots button").hasClass("unavailable")) {
                    this.submit();
                } else {
                    alert("Selected slot is unavailable. Please choose another slot.");
                }
            });
        });
    </script>
        
</body>
</html>
