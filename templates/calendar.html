<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="../static/style.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        .calendar-container {
            display: flex;
            justify-content: center;
        }
        .calendar {
            width: 1000px; /* Increase width */
            height: 800px; /* Increase height */
        }
        #calendar {
            width: 100%; /* Adjust the width as needed */
            position: absolute;
            padding-top: 10px;
        }
    </style>
</head>
<body>
    <div class="modal fade" id="eventModal" tabindex="-1" role="dialog" aria-labelledby="eventModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eventModalLabel">Add Event</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="eventForm" action="/calendar_record" method="post">
                        <div class="form-group">
                            <label for="eventTitle">Event Title</label>
                            <input type="text" class="form-control" name="event_title" id="eventTitle" required>
                        </div>
                        <div class="form-group">
                            <label for="eventDate">Date</label>
                            <input type="text" class="form-control datetimepicker" name="event_date" id="eventDate" required>
                        </div>
                        <div class="form-group">
                            <label for="startTime">Start Time</label>
                            <input type="time" class="form-control" name="start_time" id="startTime" required>
                        </div>
                        <div class="form-group">
                            <label for="endTime">End Time</label>
                            <input type="time" class="form-control" name="end_time" id="endTime">
                        </div>
                        <div class="form-group form-check">
                            <input type="checkbox" class="form-check-input" id="eventAllDay">
                            <label class="form-check-label" for="eventAllDay">All Day</label>
                        </div>
                        <div class="form-group">
                            <label for="eventRepeat">Repeat</label>
                            <select class="form-control" id="eventRepeat" name="repeat_type">
                                <option value="">No Repeat</option>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Event</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="calendar-container">
        <div id='calendar' class="calendar"></div>
    </div>

    <script src='https://code.jquery.com/jquery-3.5.1.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js'></script>
    <script src='https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.13/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/rrule@6.1.13/index.global.min.js'></script>
    <script>
      $(document).ready(function() {
          $('#eventDate').datepicker({
              format: 'yyyy-mm-dd',
              autoclose: true,
              todayHighlight: true
          });
      });

      document.addEventListener('DOMContentLoaded', function() {
          var calendarEl = document.getElementById('calendar');
          var currentView = 'dayGridMonth';
          var selectedStart;
          var selectedEnd;

          var calendar = new FullCalendar.Calendar(calendarEl, {
              initialView: currentView,
              headerToolbar: {
                  left: 'prev,next today',
                  center: 'title',
                  right: 'dayGridMonth,timeGridWeek,timeGridDay'
              },
              selectable: true,
              selectHelper: true,
              events: function(fetchInfo, successCallback, failureCallback) {
                  $.ajax({
                      url: '/events',
                      method: 'GET',
                      success: function(data) {
                          successCallback(data);
                      },
                      error: function() {
                          failureCallback();
                      }
                  });
              },
              select: function(info) {
                  selectedStart = info.startStr;
                  selectedEnd = info.endStr;
                  document.getElementById('eventDate').value = info.startStr.split('T')[0];
                  document.getElementById('startTime').value = info.startStr.split('T')[1] || '';
                  document.getElementById('endTime').value = info.endStr.split('T')[1] || '';
                  $('#eventModal').modal('show');
              },
              editable: true,
              eventClick: function(info) {
                if (confirm('Are you sure you want to delete this event?')) {
                    $.ajax({
                        url: '/delete_event',
                        method: 'POST',
                        data: {
                        event_title: info.event.title  // Send event title instead of id
                        },
                        success: function(response) {
                            if (response.status === 'success') {
                                info.event.remove();
                            } else {
                                alert(response.message);
                            }
                        },
                        error: function() {
                            alert('Failed to delete event.');
                        }
                    });
                }
            }


          });

          calendar.render();
      });
  </script>
</body>
</html>
